# 浏览器渲染过程

### 一、渲染工作流程

1. 从网络进程获取到html文件，解析dom，生成dom树

   遇到js会停下执行，外联script文件会中断dom的解析（defer、async属性的script文件除外），进行js文件下载。

   由于js中可能会有css操作，css阻塞js执行，js又会阻塞dom的解析，所以这种情况下css可能会间接阻塞dom的生成。

2. 解析css，计算样式，生成computedStyle

   1. 将css转化为styleSheet，控制台输入document.styleSheets可查看
   2. 计算属性值，如em -> px
   3. 根据继承规则和层叠规则计算各个dom元素的样式

3. 布局&分层

   布局树LayerTree：根据dom树和computedStyle生成布局树，树上只包含可见节点。

   分层：根据样式中一些特殊布局（如：opacity、flex布局且具有z-index属性、position为absoulte/releative且具有z-index属性等），浏览器会为这些拥有层叠上下文的元素创建单独的层。

4. 绘制

   将每个图层的绘制过程拆分成一个个绘制指令，组成绘制列表

5. 栅格化

   **主线程**将绘制列表提交到合成线程，由**合成线程**完成栅格化（将图快转化为位图的操作）操作。

   合成线程按照视口附近的图块来生成位图。

   栅格化过程通常会启用GPU加速。（GPU操作在GPU进程中，如果使用GPU加速则生成的位图保存在GPU内存中，完成后将结果发送回渲染进程的合成线程中进行合成图层操作）

6. 合成和显示

   当所有图块被栅格化后，合成线程会发出绘制图块的命令，由浏览器进程执行，会将内容绘制到内存中，再将内存显示在屏幕上。

### 二、重排、重绘及合成

1. 重排触发第2步流程，开销最大

   重排：修改布局样式，如元素宽高、布局等

2. 重绘触发第4步流程

   重绘：如修改元素颜色

3. 合成触发第5步流程，开销最小，在非主线程上完成

   合成：如通过transform属性进行元素变换，通常也是css动画优化的方向

一些疑惑：

据网上的资料，css解析过程和dom解析过程是并行进行的，而css解析和dom解析都是进行在渲染进程的主线程中，那这个过程怎么并行完成呢？